{"enable":true,"script":false,"acl":"@","sandbox":"{}","src":"appDIS.factory('User', function($rootScope, Direct, WatchDog, growlService) {\r\n \r\n var say_welcome = false;\r\n \r\n var _profile = {\r\n     login: 'Unknow',\r\n     isAdmin: false,\r\n     data: {}\r\n };\r\n \r\n $rootScope.$on('WatchDog.status', function(event, args){\r\n   $rootScope.$broadcast('User.status', args);  \r\n });\r\n \r\n /* Уведомления состояния соединения */\r\n $rootScope.$on('WatchDog.change', function(event, args){\r\n   $rootScope.$broadcast('User.change', args);\r\n   if (args.connected) {\r\n    $rootScope.$broadcast('User.connect', args);\r\n    publicUpdateProfile();\r\n    if (!args.session || !args.authorized) {\r\n      $rootScope.$broadcast('User.error', args);\r\n      \r\n       /* таймер для паузы на отработку swal.close(); */\r\n        swal.close();\r\n        setTimeout(function () {\r\n          swal({   \r\n            title: \"Внимание\",   \r\n            text:  \"Текущая сессия была прервана сервером!\",   \r\n            type:  \"warning\",   \r\n            showConfirmButton: true,\r\n            showCancelButton:  true,   \r\n            confirmButtonColor: \"#DD6B55\",   \r\n            confirmButtonText:  \"Авторизоваться\",\r\n            cancelButtonColor:  \"#DD6B55\",   \r\n            cancelButtonText:   \"Отменить\",\r\n            closeOnConfirm: false, \r\n            closeOnCancel: true,    \r\n          }, function(isConfirm){\r\n            if (isConfirm) {     \r\n              var path = location.pathname.replace(\"index.html\", \"\");\r\n              location.assign(path);\r\n            }\r\n          });\r\n        }, 600);\r\n      \r\n      }  \r\n    } else {\r\n      $rootScope.$broadcast('User.disconnect', args);\r\n      swal('Соединение с сервером потеряно!', 'Необходимо дождаться восстановления связи.', 'warning');  \r\n    }  \r\n  });\r\n \r\n function logout() {\r\n    WatchDog.logout();\r\n    Direct.Users.logout();\r\n    $rootScope.$broadcast('User.logout');\r\n    setTimeout(function () {\r\n      var path = location.pathname.replace(\"index.html\", \"\");\r\n      location.assign(path);\r\n    }, 2000);\r\n }\r\n \r\n function publicLogout(show) {\r\n    if (show) {\r\n      swal({   \r\n        title: \"Внимание!\",   \r\n        text:  \"Вы действительно хотете выйти из программы!\",   \r\n        type:  \"warning\",   \r\n        showConfirmButton:  true,\r\n        showCancelButton:   true,   \r\n        confirmButtonColor: \"#DD6B55\",   \r\n        confirmButtonText:  \"Выйти\",\r\n        cancelButtonColor:  \"#DD6B55\",   \r\n        cancelButtonText:   \"Отменить\",\r\n        closeOnConfirm:     false, \r\n        closeOnCancel:      true    \r\n      }, function(isConfirm) {\r\n        if (isConfirm) {     \r\n          logout();\r\n        }\r\n      });  \r\n    } else {\r\n      logout();  \r\n    }\r\n }\r\n \r\n  function publicUpdateProfile() {\r\n    Direct.Users.profile({}, (err, data)=>{\r\n      if (err){return;}\r\n      _profile = data;\r\n      $rootScope.$broadcast('User.update', _profile);\r\n      welcome();\r\n    });   \r\n  }\r\n \r\n function welcome(){\r\n    //Welcome Message\r\n    if (!say_welcome) {\r\n       growlService.growl('Добро пожаловать '+(_profile.data.name || _profile.login)+'!', 'inverse');\r\n       say_welcome = true;\r\n    }\r\n }\r\n \r\n function publicProfile() {\r\n   return _profile;\r\n }\r\n\r\n  \r\n return {\r\n   update:  publicUpdateProfile,    \r\n   profile: publicProfile,\r\n   logout:  publicLogout\r\n };\r\n \r\n});  "}